# UDIM: Conceptual IaC for SQS Queue (MAIPP Notifications)

This document outlines the conceptual Infrastructure as Code (IaC) definitions, using AWS CloudFormation or Terraform syntax as illustrative examples, for provisioning the SQS queue and associated Dead-Letter Queue (DLQ) required by UDIM to notify MAIPP of new data packages.

## 1. AWS SQS Queue for MAIPP Notifications

**Objective:** To create a durable, scalable SQS queue that UDIM publishes messages to when a new `UserDataPackage` is successfully ingested and ready for processing by MAIPP.

**Key Considerations:**
*   **Queue Type:** Standard Queue (for high throughput, at-least-once delivery) is likely sufficient. FIFO queue (`.fifo` suffix) could be considered if strict order of processing for MAIPP is critical for a specific user's data packages, but adds complexity and has lower throughput limits. For Phase 1, Standard is recommended.
*   **Visibility Timeout:** Set appropriately to allow MAIPP enough time to process a message. If MAIPP fails to process and delete the message within this timeout, it becomes visible again for another attempt. Recommended: 2-5 minutes, adjust based on observed MAIPP processing times.
*   **Message Retention Period:** How long messages should be kept in the queue if not processed (e.g., 4 days default, up to 14 days). 4 days is a reasonable default.
*   **Dead-Letter Queue (DLQ):** Essential for handling messages that consistently fail processing in MAIPP. This prevents "poison pill" messages from blocking the queue.
*   **Permissions (Queue Policy & IAM Roles):**
    *   UDIM service IAM role needs `sqs:SendMessage` permission to this queue.
    *   MAIPP service IAM role needs `sqs:ReceiveMessage`, `sqs:DeleteMessage`, `sqs:GetQueueAttributes` permissions on this queue.
    *   The SQS queue policy should grant these permissions to the respective service roles.
*   **Encryption:** Enable server-side encryption (SSE) for the SQS queue using AWS managed keys (SSE-SQS) or a KMS key (SSE-KMS) for enhanced security.

**Illustrative IaC (Terraform Example Comments):**

```terraform
# variable "aws_region" {}
# variable "aws_account_id" {}
# variable "environment" {} # e.g., "dev", "staging", "prod"
# variable "udim_service_iam_role_arn" {}
# variable "maipp_service_iam_role_arn" {}

# resource "aws_sqs_queue" "maipp_notification_dlq" {
#   name                      = "maipp-notification-dlq-${var.environment}"
#   message_retention_seconds = 1209600 # 14 days (max retention for DLQ)
#   # kms_master_key_id         = "alias/aws/sqs" # Optional: SSE-KMS for DLQ, default is SSE-SQS
#   # kms_data_key_reuse_period_seconds = 300 # Optional
#
#   tags = {
#     Name        = "MAIPP Notification DLQ"
#     Environment = var.environment
#     Project     = "EchoSphere"
#   }
# }

# resource "aws_sqs_queue" "maipp_notification_queue" {
#   name                      = "maipp-notification-queue-${var.environment}"
#   # For FIFO, add .fifo suffix and enable content_based_deduplication or provide message_deduplication_id
#   # fifo_queue                = false # Set to true for FIFO
#   delay_seconds             = 0
#   max_message_size          = 262144 # 256 KiB (standard max)
#   message_retention_seconds = 345600 # 4 days (default)
#   visibility_timeout_seconds = 300    # 5 minutes (adjust based on expected MAIPP processing time per message)
#   # kms_master_key_id         = "alias/aws/sqs" # Optional: SSE-KMS for main queue
#   # kms_data_key_reuse_period_seconds = 300 # Optional
#
#   redrive_policy = jsonencode({
#     deadLetterTargetArn = aws_sqs_queue.maipp_notification_dlq.arn
#     maxReceiveCount     = 5 # Number of times a message is received before moving to DLQ
#   })
#
#   # Policy to allow UDIM to send messages and MAIPP to receive/delete
#   # This policy is attached directly to the SQS queue.
#   # Alternatively, permissions can be granted via IAM policies attached to the service roles.
#   # Using a queue policy is often cleaner for resource-based permissions.
#   policy = data.aws_iam_policy_document.maipp_notification_queue_policy_doc.json
#
#   tags = {
#     Name        = "MAIPP Notification Queue"
#     Environment = var.environment
#     Project     = "EchoSphere"
#   }
# }

# data "aws_iam_policy_document" "maipp_notification_queue_policy_doc" {
#   statement {
#     sid    = "AllowUDIMSendMessage"
#     effect = "Allow"
#     principals {
#       type        = "AWS"
#       identifiers = [var.udim_service_iam_role_arn] # IAM Role ARN for UDIM service
#     }
#     actions   = ["sqs:SendMessage"]
#     # The resource ARN for SQS queue will be dynamically generated by Terraform.
#     # Using a data source with aws_sqs_queue.maipp_notification_queue.arn might be needed if this policy
#     # is defined before the queue resource itself in the TF configuration, or use the queue's direct arn attribute.
#     # For this illustrative example, we use a placeholder that would be substituted with the actual ARN.
#     resources = ["arn:aws:sqs:${var.aws_region}:${var.aws_account_id}:maipp-notification-queue-${var.environment}"]
#   }
#
#   statement {
#     sid    = "AllowMAIPPReceiveDeleteMessage"
#     effect = "Allow"
#     principals {
#       type        = "AWS"
#       identifiers = [var.maipp_service_iam_role_arn] # IAM Role ARN for MAIPP service
#     }
#     actions = [
#       "sqs:ReceiveMessage",
#       "sqs:DeleteMessage",
#       "sqs:GetQueueAttributes"
#     ]
#     resources = ["arn:aws:sqs:${var.aws_region}:${var.aws_account_id}:maipp-notification-queue-${var.environment}"]
#   }
#
#   # Optional: Deny insecure transport for SQS interactions
#   statement {
#     sid = "DenyInsecureTransportSQS"
#     effect = "Deny"
#     principals {
#       type = "*"
#       identifiers = ["*"]
#     }
#     actions = ["sqs:*"] # Apply to all SQS actions
#     resources = ["arn:aws:sqs:${var.aws_region}:${var.aws_account_id}:maipp-notification-queue-${var.environment}"]
#     condition {
#       test     = "Bool"
#       variable = "aws:SecureTransport"
#       values   = ["false"]
#     }
#   }
# }
```

## 2. Message Payload Schema (Reiteration)

The message published by UDIM to this SQS queue should follow a defined JSON schema, as detailed in MAIPP's API/Interaction Specification. This ensures that MAIPP can reliably parse the information needed to process the data package.

**Example Payload:**

```json
{
  "packageID": "a1b2c3d4-e5f6-7890-1234-567890abcdef", // UserDataPackage.packageID (UUID)
  "userID": "user_uuid_placeholder_123", // UUID
  "consentTokenID": "consent_uuid_placeholder_789", // UUID
  "rawDataReference": "s3://echosphere-udim-user-data-bucket/users/user_uuid_placeholder_123/packages/a1b2c3d4-e5f6-7890-1234-567890abcdef/data.enc", // String URI
  "dataType": "text/plain", // String (MIME type)
  "sourceDescription": "Direct Upload: My daily journal.txt", // String
  "metadata": { // Optional JSON object from UserDataPackage.metadata
    "originalFilename": "My daily journal.txt",
    "fileSizeBytes": 102400
    // ... other relevant metadata passed by UDIM
  }
}
```

## 3. Summary

This conceptual IaC outlines the setup for a robust SQS queue system, including a Dead-Letter Queue, to facilitate reliable and asynchronous communication from UDIM to MAIPP. Key aspects include appropriate timeouts for message processing, message retention policies, and fine-grained IAM permissions defined in the queue policy to ensure secure access. Actual implementation will involve translating these concepts into executable IaC scripts using tools like Terraform or AWS CloudFormation, ensuring dynamic references to ARNs are correctly handled.
```
